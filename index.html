<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUSD | Experimental Faucet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #000; --accent: #fff; --grey: #666; --red: #ff3e3e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Space Grotesk', sans-serif; color: var(--accent); }
        #artCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3; pointer-events: none; }
        .container { position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
        .card { background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); border: 1px solid #333; padding: 3rem; border-radius: 2px; max-width: 420px; width: 90%; text-align: center; }
        h1 { font-size: 4rem; font-weight: 700; letter-spacing: -4px; margin: 0; line-height: 0.9; }
        .sub-header { color: var(--grey); margin-bottom: 2rem; font-size: 0.75rem; letter-spacing: 4px; font-weight: 300; text-transform: uppercase; }
        .btn { background: var(--accent); color: var(--primary); border: none; padding: 16px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 10px; }
        .btn:hover { background: #bbb; }
        .btn:disabled { background: #111; color: #333; cursor: not-allowed; border: 1px solid #222; }
        #status { font-size: 0.7rem; margin-top: 1.5rem; color: var(--grey); text-transform: uppercase; letter-spacing: 1px; }
        #walletAddress { font-size: 0.6rem; color: #444; margin-top: 10px; font-family: monospace; word-break: break-all; }
        .timer-box { margin-top: 15px; padding: 10px; border: 1px solid #222; color: var(--red); font-size: 0.8rem; display: none; font-weight: bold; }
        .disclaimer { position: absolute; bottom: 20px; font-size: 0.65rem; color: #444; letter-spacing: 1px; text-transform: uppercase; width: 100%; text-align: center; }
    </style>
</head>
<body>

<canvas id="artCanvas"></canvas>

<div class="container">
    <div class="card">
        <h1>PUSD</h1>
        <div class="sub-header">Westend Testnet Exp.</div>
        
        <button class="btn" id="mainBtn" onclick="handleLogic()">INITIALIZE UPLINK</button>
        <p id="walletAddress"></p>

        <div id="actionPanel" style="display:none;">
            <div id="timerDisplay" class="timer-box"></div>
            <button class="btn" style="background:transparent; color:white; border:1px solid white;" onclick="watchToken()">Add PUSD to Wallet</button>
        </div>

        <p id="status">Awaiting Input...</p>
    </div>
</div>

<div class="disclaimer">
    Experimental Environment: Asset-Hub Westend - No Real Value.
</div>

<script>
    // --- SFONDO LOGARITMICO ---
    const canvas = document.getElementById('artCanvas');
    const ctx = canvas.getContext('2d');
    function drawArt() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.fillStyle = "black"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (let i = 1; i < 60; i++) {
            const size = (Math.random() * 25) / Math.log(i + 1.5);
            ctx.beginPath();
            ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, size, 0, Math.PI * 2);
            ctx.fillStyle = "white"; ctx.fill();
        }
    }
    drawArt();

    // --- CONFIG ---
    const TARGET_HEX = '0x19082935'; 
    const CONTRACT_ADDR = "0xdd1747d54fa8d568f9e25b5fbf08561fe6b39f41";
    const WESTEND_DATA = {
        chainId: TARGET_HEX,
        chainName: 'Asset-Hub Westend Testnet',
        nativeCurrency: { name: 'WND', symbol: 'WND', decimals: 18 },
        rpcUrls: ['https://westend-asset-hub-eth-rpc.polkadot.io'],
        blockExplorerUrls: ['https://assethub-westend.subscan.io']
    };

    let signer, contract, step = "connect";

    window.addEventListener('load', () => {
        if (sessionStorage.getItem('pendingUplink') === 'true') {
            sessionStorage.removeItem('pendingUplink');
            handleLogic();
        }
    });

    async function handleLogic() {
        if (!window.ethereum) return alert("MetaMask non trovato");

        try {
            if (step === "connect") {
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (currentChainId !== TARGET_HEX) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: TARGET_HEX }] });
                        sessionStorage.setItem('pendingUplink', 'true');
                        location.reload();
                        return;
                    } catch (e) {
                        if (e.code === 4902) {
                            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [WESTEND_DATA] });
                            sessionStorage.setItem('pendingUplink', 'true');
                            location.reload();
                            return;
                        } else throw e;
                    }
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, [
                    "function claimToken() external",
                    "function lastClaim(address) view returns (uint256)"
                ], signer);

                document.getElementById('walletAddress').innerText = accounts[0];
                document.getElementById('actionPanel').style.display = "block";
                
                // CONTROLLO COOLDOWN IMMEDIATO
                await updateCooldown(accounts[0]);
                return;
            }

            if (step === "verify") {
                document.getElementById('mainBtn').disabled = true;
                document.getElementById('status').innerText = "ANALYZING BIOMETRICS...";
                setTimeout(() => {
                    document.getElementById('mainBtn').disabled = false;
                    document.getElementById('mainBtn').innerText = "CLAIM 1.00 PUSD";
                    document.getElementById('status').innerText = "ENTITY VERIFIED";
                    step = "claim";
                }, 1500);
                return;
            }

            if (step === "claim") {
                document.getElementById('status').innerText = "TRANSMITTING...";
                document.getElementById('mainBtn').disabled = true;
                const tx = await contract.claimToken();
                await tx.wait();
                document.getElementById('status').innerText = "SUCCESSFUL";
                document.getElementById('mainBtn').innerText = "SECURED";
                location.reload(); // Ricarica per aggiornare il timer
            }

        } catch (err) {
            console.error(err);
            document.getElementById('status').innerText = "PROTOCOL ERROR";
        }
    }

    async function updateCooldown(address) {
        const lastClaimTime = await contract.lastClaim(address);
        const lastClaimSeconds = lastClaimTime.toNumber();
        
        if (lastClaimSeconds === 0) {
            // Mai fatto claim
            readyToVerify();
            return;
        }

        const nextClaimTime = (lastClaimSeconds + (7 * 24 * 60 * 60)) * 1000;
        const now = Date.now();

        if (now < nextClaimTime) {
            // Cooldown attivo
            step = "locked";
            document.getElementById('mainBtn').disabled = true;
            document.getElementById('mainBtn').innerText = "UPLINK LOCKED";
            document.getElementById('status').innerText = "COOLDOWN IN EFFECT";
            document.getElementById('timerDisplay').style.display = "block";
            
            startTimer(nextClaimTime);
        } else {
            readyToVerify();
        }
    }

    function readyToVerify() {
        document.getElementById('status').innerText = "HUMANITY CHECK REQUIRED";
        document.getElementById('mainBtn').innerText = "PROOF THAT I AM HUMAN";
        step = "verify";
    }

    function startTimer(target) {
        const timerInterval = setInterval(() => {
            const now = Date.now();
            const diff = target - now;

            if (diff <= 0) {
                clearInterval(timerInterval);
                location.reload();
                return;
            }

            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('timerDisplay').innerText = 
                `NEXT CLAIM IN: ${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
    }

    async function watchToken() {
        try {
            await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: { address: CONTRACT_ADDR, symbol: 'PUSD', decimals: 18 },
                },
            });
        } catch (e) {}
    }
</script>
</body>
</html>
