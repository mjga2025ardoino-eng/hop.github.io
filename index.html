<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUSD Alpha 0.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-transform: uppercase;
        }
        .card {
            border: 1px solid #333;
            padding: 40px;
            width: 350px;
            text-align: center;
        }
        h1 { font-size: 24px; letter-spacing: 5px; margin-bottom: 10px; }
        .sub { font-size: 10px; color: #666; margin-bottom: 30px; letter-spacing: 2px; }
        
        button {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        button:disabled { background: #222; color: #444; cursor: not-allowed; }
        
        #status { font-size: 10px; color: #888; margin-top: 20px; }
        #addr { font-size: 9px; color: #444; margin-top: 10px; word-break: break-all; }
        #timer { color: #ff0000; font-size: 11px; margin-top: 10px; display: none; }
        
        .v { position: fixed; bottom: 20px; left: 20px; font-size: 10px; color: #333; }
    </style>
</head>
<body>

<div class="v">ALPHA 0.2</div>

<div class="card">
    <h1>PUSD</h1>
    <div class="sub">WESTEND ASSET HUB</div>

    <button id="btn" onclick="run()">CONNECT WALLET</button>
    <div id="extra" style="display:none">
        <button onclick="addToken()" style="background:none; color:#fff; border:1px solid #333">ADD TOKEN</button>
    </div>

    <div id="timer"></div>
    <div id="status">READY</div>
    <div id="addr"></div>
</div>

<script>
    const TARGET_HEX = '0x19082935';
    const CONTRACT = "0xdd1747d54fa8d568f9e25b5fbf08561fe6b39f41";
    const RPC = {
        chainId: TARGET_HEX,
        chainName: 'Asset-Hub Westend',
        nativeCurrency: { name: 'WND', symbol: 'WND', decimals: 18 },
        rpcUrls: ['https://westend-asset-hub-eth-rpc.polkadot.io'],
        blockExplorerUrls: ['https://assethub-westend.subscan.io']
    };

    let signer, contract, step = "connect";

    async function run() {
        if (!window.ethereum) return alert("MetaMask missing");
        const btn = document.getElementById('btn');
        const st = document.getElementById('status');

        try {
            if (step === "connect") {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId.toLowerCase() !== TARGET_HEX.toLowerCase()) {
                    st.innerText = "SWITCHING NETWORK...";
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: TARGET_HEX }]
                        });
                    } catch (e) {
                        if (e.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [RPC]
                            });
                        }
                    }
                    st.innerText = "NETWORK OK - CLICK AGAIN";
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT, [
                    "function claimToken() external",
                    "function lastClaim(address) view returns (uint256)"
                ], signer);

                document.getElementById('addr').innerText = accounts[0];
                document.getElementById('extra').style.display = "block";
                
                await checkLock(accounts[0]);
                return;
            }

            if (step === "verify") {
                st.innerText = "VERIFYING...";
                btn.disabled = true;
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "CLAIM 1.00 PUSD";
                    st.innerText = "HUMAN CONFIRMED";
                    step = "claim";
                }, 1000);
                return;
            }

            if (step === "claim") {
                st.innerText = "SENDING...";
                btn.disabled = true;
                const tx = await contract.claimToken();
                await tx.wait();
                st.innerText = "SUCCESS";
                btn.innerText = "RECEIVED";
                location.reload();
            }

        } catch (err) {
            console.error(err);
            st.innerText = "ERROR";
            btn.disabled = false;
        }
    }

    async function checkLock(address) {
        const last = await contract.lastClaim(address);
        const next = (last.toNumber() + (7 * 24 * 60 * 60)) * 1000;
        
        if (Date.now() < next) {
            document.getElementById('btn').disabled = true;
            document.getElementById('btn').innerText = "LOCKED";
            document.getElementById('status').innerText = "COOLDOWN";
            showTimer(next);
        } else {
            document.getElementById('btn').innerText = "PROOF OF HUMAN";
            document.getElementById('status').innerText = "CONNECTED";
            step = "verify";
        }
    }

    function showTimer(target) {
        const div = document.getElementById('timer');
        div.style.display = "block";
        const itv = setInterval(() => {
            const diff = target - Date.now();
            if (diff <= 0) { clearInterval(itv); location.reload(); }
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            div.innerText = `NEXT: ${d}D ${h}H ${m}M ${s}S`;
        }, 1000);
    }

    async function addToken() {
        await window.ethereum.request({
            method: 'wallet_watchAsset',
            params: {
                type: 'ERC20',
                options: { address: CONTRACT, symbol: 'PUSD', decimals: 18 }
            }
        });
    }
</script>
</body>
</html>
