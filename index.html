<script>
    // --- DYNAMIC LOGARITHMIC CANVAS (Unchanged) ---
    const canvas = document.getElementById('artCanvas');
    const ctx = canvas.getContext('2d');
    function drawLogarithmicArt() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.fillStyle = "black"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const count = 50 + Math.floor(Math.random() * 50);
        for (let i = 1; i < count; i++) {
            const posX = Math.random() * canvas.width;
            const posY = Math.random() * canvas.height;
            const size = Math.random() * (15 / Math.log(i + 1));
            ctx.beginPath(); ctx.arc(posX, posY, size, 0, Math.PI * 2);
            ctx.fillStyle = "white"; ctx.fill(); ctx.closePath();
        }
    }
    drawLogarithmicArt();

    // --- UPDATED LOGIC FOR AUTO-UPLINK ---
    const TARGET_ID = '420420421';
    const TARGET_HEX = '0x19082935';
    const CONTRACT_ADDR = "0xdd1747d54fa8d568f9e25b5fbf08561fe6b39f41";
    
    const WESTEND_DATA = {
        chainId: TARGET_HEX,
        chainName: 'Asset-Hub Westend Testnet',
        nativeCurrency: { name: 'WND', symbol: 'WND', decimals: 18 },
        rpcUrls: ['https://westend-asset-hub-eth-rpc.polkadot.io'],
        blockExplorerUrls: ['https://assethub-westend.subscan.io']
    };

    let signer, contract;

    // Funzione eseguita all'avvio per ripristinare la sessione se già connessi
    window.onload = async () => {
        if (window.ethereum && window.ethereum.selectedAddress) {
            console.log("Existing session detected, re-establishing uplink...");
            initConnection();
        }
    };

    async function initConnection() {
        if (!window.ethereum) return alert("Install MetaMask");
        
        try {
            document.getElementById('status').innerText = "SYNCHRONIZING NETWORK...";
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const { chainId } = await provider.getNetwork();

            // Se la rete è sbagliata, chiediamo il cambio
            if (chainId.toString() !== TARGET_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: TARGET_HEX }],
                    });
                    // Il cambio rete triggera spesso il ricaricamento, 
                    // ma per sicurezza chiamiamo il reload noi stessi dopo un breve delay
                    setTimeout(() => location.reload(), 500);
                    return;
                } catch (e) {
                    if (e.code === 4902) {
                        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [WESTEND_DATA] });
                        setTimeout(() => location.reload(), 500);
                    }
                    throw e;
                }
            }

            // Se siamo qui, la rete è corretta. Connettiamo l'account.
            const accounts = await provider.send("eth_requestAccounts", []);
            if (accounts.length > 0) {
                signer = provider.getSigner();
                const addr = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDR, ["function claimToken() external", "function lastClaim(address) view returns (uint256)"], signer);

                document.getElementById('walletAddress').innerText = addr;
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('actionPanel').style.display = 'block';
                document.getElementById('status').innerText = "UPLINK ESTABLISHED";
                
                checkCooldown(addr);
            }
        } catch (err) {
            console.error(err);
            document.getElementById('status').innerText = "UPLINK FAILED - RETRY";
        }
    }

    // Resto delle funzioni (checkCooldown, verifyHuman, claim, watchToken) rimangono uguali
    async function checkCooldown(addr) {
        try {
            const last = await contract.lastClaim(addr);
            const next = (last.toNumber() + (7 * 24 * 60 * 60)) * 1000;
            if (Date.now() < next) {
                document.getElementById('pohBtn').disabled = true;
                document.getElementById('status').innerText = "COOLDOWN ACTIVE";
                document.getElementById('claimTimer').innerText = `SYNC READY: ${new Date(next).toLocaleDateString()}`;
                document.getElementById('claimTimer').style.display = 'block';
            }
        } catch (e) {}
    }

    function verifyHuman() {
        document.getElementById('pohBtn').innerText = "SCANNING...";
        setTimeout(() => {
            document.getElementById('pohBtn').disabled = true;
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('status').innerText = "CARBON LIFEFORM CONFIRMED";
        }, 1500);
    }

    async function claim() {
        try {
            document.getElementById('status').innerText = "TRANSMITTING...";
            const tx = await contract.claimToken();
            await tx.wait();
            document.getElementById('status').innerText = "TRANSFER SUCCESSFUL";
            document.getElementById('claimBtn').disabled = true;
        } catch (err) {
            document.getElementById('status').innerText = "PROTOCOL REJECTED";
        }
    }

    async function watchToken() {
        try {
            await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: { address: CONTRACT_ADDR, symbol: 'PUSD', decimals: 18 },
                },
            });
        } catch (error) {}
    }
</script>
