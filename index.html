<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitToken DApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; text-align: center; }
        button { background-color: #e6007a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px 5px; transition: background 0.3s; }
        button:hover { background-color: #c40068; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .info { margin: 20px 0; padding: 10px; border: 1px solid #eee; border-radius: 8px; font-size: 14px; word-break: break-all; }
        #status { font-weight: bold; margin-top: 15px; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h1>Rabbit Token üêá</h1>
    <p>Interagisci con HOP su Westend Asset Hub</p>

    <button id="connectBtn">Connetti MetaMask</button>
    
    <div id="walletInfo" class="info" style="display:none;">
        <strong>Account:</strong> <span id="account"></span><br>
        <strong>Bilancio:</strong> <span id="balance">0</span> HOP
    </div>

    <div id="actions" style="display:none;">
        <button id="hopBtn">Esegui HOP</button>
        <button id="claimBtn">Claim Wisdom</button>
    </div>

    <p id="status">In attesa di connessione...</p>
</div>

<script>
    const CONTRACT_ADDRESS = "0xc3432f679e465073dbc84F3B613a20f12EdB5dC1";
    const ABI = [
        "function hop() external",
        "function claimWisdom() external",
        "function balanceOf(address) view returns (uint256)",
        "function hasHopped(address) view returns (bool)",
        "function hasClaimed(address) view returns (bool)"
    ];

   const WESTEND_ASSET_HUB_PARAMS = {
    chainId: "0x190a0714", // 420420420 decimale
    chainName: "Westend Asset Hub",
    nativeCurrency: { name: "Westend", symbol: "WND", decimals: 12 },
    rpcUrls: ["https://westend-asset-hub-eth-rpc.polkadot.io"],
    blockExplorerUrls: ["https://assethub-westend.subscan.io/"]
};

async function switchNetwork() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: WESTEND_ASSET_HUB_PARAMS.chainId }],
        });
    } catch (switchError) {
        // Errore 4902: la rete non √® aggiunta a MetaMask
        if (switchError.code === 4902) {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [WESTEND_ASSET_HUB_PARAMS],
                });
            } catch (addError) {
                console.error("Errore durante l'aggiunta della rete:", addError);
                throw addError;
            }
        } else {
            console.error("Errore durante lo switch della rete:", switchError);
            throw switchError;
        }
    }
}

document.getElementById('connectBtn').onclick = async () => {
    if (!window.ethereum) return alert("Installa MetaMask!");
    
    try {
        document.getElementById('status').innerText = "Tentativo di connessione rete...";
        await switchNetwork();
        
        provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        
        if (accounts.length > 0) {
            signer = await provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            document.getElementById('status').innerText = "Connesso correttamente!";
            await updateUI();
        }
    } catch (err) {
        console.error("Dettaglio Errore:", err);
        // Questo ti dir√† esattamente cosa non va nella console F12
        document.getElementById('status').innerText = "Errore connessione: " + (err.message || "Controlla la console");
    }
};

    async function updateUI() {
        const address = await signer.getAddress();
        const balance = await contract.balanceOf(address);
        document.getElementById('account').innerText = address;
        document.getElementById('balance').innerText = ethers.formatUnits(balance, 18);
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('actions').style.display = 'block';
        document.getElementById('connectBtn').innerText = "Wallet Connesso";
    }

    document.getElementById('connectBtn').onclick = async () => {
        if (!window.ethereum) return alert("Installa MetaMask!");
        
        try {
            await switchNetwork();
            provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            document.getElementById('status').innerText = "Connesso correttamente.";
            await updateUI();
        } catch (err) {
            console.error(err);
            document.getElementById('status').innerText = "Errore connessione.";
        }
    };

    document.getElementById('hopBtn').onclick = async () => {
        try {
            document.getElementById('status').innerText = "Conferma la transazione HOP su MetaMask...";
            const tx = await contract.hop();
            document.getElementById('status').innerText = "Transazione inviata... attendi conferma.";
            await tx.wait();
            document.getElementById('status').innerText = "HOP completato con successo!";
        } catch (err) {
            handleError(err);
        }
    };

    document.getElementById('claimBtn').onclick = async () => {
        try {
            document.getElementById('status').innerText = "Conferma la transazione CLAIM...";
            const tx = await contract.claimWisdom();
            document.getElementById('status').innerText = "Transazione inviata... attendi conferma.";
            await tx.wait();
            document.getElementById('status').innerText = "Wisdom Claimed! Hai bruciato 1 HOP.";
            await updateUI();
        } catch (err) {
            handleError(err);
        }
    };

    function handleError(err) {
        // Gestione errori custom del contratto
        if (err.reason) {
            document.getElementById('status').innerText = "Errore: " + err.reason;
        } else if (err.message.includes("HopFirst")) {
            document.getElementById('status').innerText = "Errore: Devi fare HOP prima!";
        } else if (err.message.includes("AlreadyClaimed")) {
            document.getElementById('status').innerText = "Errore: Hai gi√† richiesto la Wisdom!";
        } else {
            document.getElementById('status').innerText = "Errore durante la transazione.";
        }
        console.error(err);
    }
</script>

</body>
</html>

