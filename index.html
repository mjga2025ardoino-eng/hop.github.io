
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body {
                  background-color: white; /* Ensure the iframe has a white background */
                }

                
              </style>
                        </head>
                        <body>
                            

              <script>
                              // CONFIGURAZIONE UFFICIALE ASSET-HUB WESTEND
const CONTRACT_ADDRESS = "0x087Ea7C436cd9689C9aad64E5B76C6C1C3771Ad9";
const ASSET_HUB_WESTEND_RPC = "https://westend-asset-hub-eth-rpc.polkadot.io";
const ASSET_HUB_WESTEND_CHAIN_ID = "0x1905F5D5"; // 420420421 in esadecimale

const CONTRACT_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function hop()",
  "function claimWisdom()",
  "function hasHopped(address) view returns (bool)",
  "function hasClaimed(address) view returns (bool)"
];

// ELEMENTI DOM
const connectBtn = document.getElementById('connect-btn');
const accountInfo = document.getElementById('account-info');
const addressDisplay = document.getElementById('address-display');
const dashboard = document.getElementById('dashboard');
const hopBalance = document.getElementById('hop-balance');
const hoppedStatus = document.getElementById('hopped-status');
const wisdomStatus = document.getElementById('wisdom-status');
const hopBtn = document.getElementById('hop-btn');
const claimBtn = document.getElementById('claim-btn');
const wisdomSection = document.getElementById('wisdom-section');
const errorModal = document.getElementById('error-modal');
const errorMessage = document.getElementById('error-message');
const closeError = document.getElementById('close-error');

let provider = null;
let signer = null;
let contract = null;
let currentAccount = null;

// INIZIALIZZAZIONE
async function init() {
  // Verifica se MetaMask è presente
  if (!window.ethereum) {
    showError('MetaMask non rilevato. Installalo per interagire con la dApp.');
    return;
  }

  // Aggiungi AssetHub Westend a MetaMask se non presente
  try {
    await window.ethereum.request({
      method: 'wallet_addEthereumChain',
      params: [{
        chainId: ASSET_HUB_WESTEND_CHAIN_ID,
        chainName: 'Polkadot AssetHub Westend',
        rpcUrls: [ASSET_HUB_WESTEND_RPC],
        nativeCurrency: {
          name: 'WND',
          symbol: 'WND',
          decimals: 18
        },
        blockExplorerUrls: ['https://assethub-westend.subscan.io']
      }]
    });
  } catch (addError) {
    // La rete potrebbe già essere aggiunta - ignora l'errore
    if (addError.code !== 4902) {
      console.warn('Could not add AssetHub Westend network:', addError);
    }
  }

  // Prova connessione automatica
  await autoConnect();
  
  // Event listeners
  connectBtn.addEventListener('click', connectWallet);
  hopBtn.addEventListener('click', executeHop);
  claimBtn.addEventListener('click', claimWisdom);
  closeError.addEventListener('click', () => errorModal.classList.add('hidden'));
  
  // Ricarica su cambio account/rete
  window.ethereum.on('accountsChanged', () => location.reload());
  window.ethereum.on('chainChanged', () => location.reload());
}

// CONNESSIONE AUTOMATICA
async function autoConnect() {
  try {
    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
    if (accounts.length > 0) {
      // Forza la rete AssetHub Westend
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: ASSET_HUB_WESTEND_CHAIN_ID }]
      });
      await setupWallet(accounts[0]);
    }
  } catch (err) {
    // Silenzioso - aspetta connessione manuale
    console.log('Auto-connect non disponibile');
  }
}

// CONNESSIONE MANUALE
async function connectWallet() {
  if (!window.ethereum) {
    showError('MetaMask non rilevato');
    return;
  }

  try {
    // Richiedi account e cambia rete
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: ASSET_HUB_WESTEND_CHAIN_ID }]
    });
    
    await setupWallet(accounts[0]);
  } catch (err) {
    if (err.code === 4001) {
      showError('Connessione annullata');
    } else {
      showError('Impossibile connettersi ad AssetHub Westend');
      console.error('Connection error:', err);
    }
  }
}

// CONFIGURAZIONE WALLET CON PROVIDER CORRETTO
async function setupWallet(account) {
  currentAccount = account;
  
  // Usa direttamente la RPC di AssetHub Westend per evitare problemi
  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();
  
  // Verifica connessione alla rete corretta
  const network = await provider.getNetwork();
  if (network.chainId.toString() !== "420420421") {
    showError('Sei su una rete diversa. Seleziona AssetHub Westend in MetaMask.');
    return;
  }
  
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  
  // Aggiorna UI
  addressDisplay.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
  connectBtn.classList.add('hidden');
  accountInfo.classList.remove('hidden');
  dashboard.classList.remove('hidden');
  
  await refreshData();
}

// AGGIORNA DATI
async function refreshData() {
  if (!contract || !currentAccount) return;
  
  try {
    const balance = await contract.balanceOf(currentAccount);
    const hasHopped = await contract.hasHopped(currentAccount);
    const hasClaimed = await contract.hasClaimed(currentAccount);
    
    hopBalance.textContent = ethers.utils.formatUnits(balance, 18);
    hoppedStatus.textContent = hasHopped ? '✅' : '❌';
    wisdomStatus.textContent = hasClaimed ? '✅' : '❌';
    
    hopBtn.disabled = hasHopped;
    claimBtn.disabled = !hasHopped || hasClaimed;
    
    if (hasClaimed) {
      wisdomSection.classList.remove('hidden');
    }
  } catch (err) {
    console.error('Refresh error:', err);
    showError('Errore nella lettura dei dati. Verifica la rete.');
  }
}

// ESEGUE HOP
async function executeHop() {
  if (!contract) return;
  
  try {
    const tx = await contract.hop();
    await tx.wait();
    await refreshData();
  } catch (err) {
    if (err.code !== 4001) {
      showError('Hop fallito. Verifica saldo WND e HOP.');
      console.error('Hop error:', err);
    }
  }
}

// CLAIM WISDOM
async function claimWisdom() {
  if (!contract) return;
  
  try {
    const tx = await contract.claimWisdom();
    await tx.wait();
    wisdomSection.classList.remove('hidden');
    await refreshData();
  } catch (err) {
    if (err.code !== 4001) {
      showError('Claim fallito. Necessario almeno 1 HOP token.');
      console.error('Claim error:', err);
    }
  }
}

// MOSTRA ERRORE
function showError(message) {
  errorMessage.textContent = message;
  errorModal.classList.remove('hidden');
}

// AVVIA L'APPLICAZIONE
document.addEventListener('DOMContentLoaded', init);


              </script>
                        </body>
                        </html>
                    
