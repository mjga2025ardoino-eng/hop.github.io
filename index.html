
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body {
                  background-color: white; /* Ensure the iframe has a white background */
                }

                
              </style>
                        </head>
                        <body>
                            

              <script>
                              // CONFIGURAZIONE
const CONTRACT_ADDRESS = "0x087Ea7C436cd9689C9aad64E5B76C6C1C3771Ad9";
const CONTRACT_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function hop()",
  "function claimWisdom()",
  "function hasHopped(address) view returns (bool)",
  "function hasClaimed(address) view returns (bool)"
];

// Chain ID corretto per AssetHub Westend (DECIMALE: 420420421)
const ASSET_HUB_WESTEND_CHAIN_ID = "0x1905F5D5"; // Esadecimale di 420420421

// ELEMENTI DOM
const connectBtn = document.getElementById('connect-btn');
const accountInfo = document.getElementById('account-info');
const addressDisplay = document.getElementById('address-display');
const dashboard = document.getElementById('dashboard');
const hopBalance = document.getElementById('hop-balance');
const hoppedStatus = document.getElementById('hopped-status');
const wisdomStatus = document.getElementById('wisdom-status');
const hopBtn = document.getElementById('hop-btn');
const claimBtn = document.getElementById('claim-btn');
const wisdomSection = document.getElementById('wisdom-section');
const errorModal = document.getElementById('error-modal');
const errorMessage = document.getElementById('error-message');
const closeError = document.getElementById('close-error');

// STATO
let provider = null;
let signer = null;
let contract = null;
let currentAccount = null;

// INIZIALIZZAZIONE
async function init() {
  await autoConnect();
  
  connectBtn.addEventListener('click', connectWallet);
  hopBtn.addEventListener('click', executeHop);
  claimBtn.addEventListener('click', claimWisdom);
  closeError.addEventListener('click', () => errorModal.classList.add('hidden'));
  
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', () => location.reload());
    window.ethereum.on('chainChanged', () => location.reload());
  }
}

// CONNESSIONE AUTOMATICA
async function autoConnect() {
  if (!window.ethereum) return;
  
  try {
    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
    if (accounts.length > 0) {
      // Verifica prima la rete
      const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
      if (currentChainId.toLowerCase() !== ASSET_HUB_WESTEND_CHAIN_ID.toLowerCase()) {
        await switchToAssetHubWestend();
      }
      await setupWallet(accounts[0]);
    }
  } catch (err) {
    console.log('Auto-connect failed:', err);
  }
}

// CONNESSIONE MANUALE
async function connectWallet() {
  if (!window.ethereum) {
    showError('MetaMask non rilevato. Installalo per procedere.');
    return;
  }

  try {
    // Richiedi account
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    if (accounts.length === 0) throw new Error('Nessun account trovato');
    
    // Verifica/cambia rete
    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (currentChainId.toLowerCase() !== ASSET_HUB_WESTEND_CHAIN_ID.toLowerCase()) {
      await switchToAssetHubWestend();
    }
    
    await setupWallet(accounts[0]);
  } catch (err) {
    if (err.code === 4001) {
      showError('Connessione annullata dall\'utente.');
    } else if (err.message?.includes('wallet_addEthereumChain')) {
      showError('Impossibile aggiungere AssetHub Westend. Controlla la configurazione.');
    } else {
      showError(`Errore di connessione: ${err.message || 'Sconosciuto'}`);
    }
  }
}

// CAMBIA RETE AD ASSET-HUB WESTEND
async function switchToAssetHubWestend() {
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: ASSET_HUB_WESTEND_CHAIN_ID }]
    });
  } catch (switchError) {
    if (switchError.code === 4902) {
      // Aggiungi la rete
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: ASSET_HUB_WESTEND_CHAIN_ID,
          chainName: 'Polkadot AssetHub Westend',
          rpcUrls: ['https://westend-asset-hub-eth-rpc.polkadot.io'],
          nativeCurrency: {
            name: 'WND',
            symbol: 'WND',
            decimals: 18
          },
          blockExplorerUrls: ['https://assethub-westend.subscan.io']
        }]
      });
    } else {
      throw switchError;
    }
  }
}

// CONFIGURA WALLET
async function setupWallet(account) {
  currentAccount = account;
  addressDisplay.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
  connectBtn.classList.add('hidden');
  accountInfo.classList.remove('hidden');
  dashboard.classList.remove('hidden');
  
  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  
  await refreshData();
}

// AGGIORNA DATI
async function refreshData() {
  if (!contract || !currentAccount) return;
  
  try {
    const balance = await contract.balanceOf(currentAccount);
    const hasHopped = await contract.hasHopped(currentAccount);
    const hasClaimed = await contract.hasClaimed(currentAccount);
    
    hopBalance.textContent = ethers.utils.formatUnits(balance, 18);
    
    hoppedStatus.textContent = hasHopped ? '✅' : '❌';
    hoppedStatus.className = `stat-value ${hasHopped ? 'success' : 'error'}`;
    
    wisdomStatus.textContent = hasClaimed ? '✅' : '❌';
    wisdomStatus.className = `stat-value ${hasClaimed ? 'success' : 'error'}`;
    
    hopBtn.disabled = hasHopped;
    claimBtn.disabled = !hasHopped || hasClaimed;
    
    if (hasClaimed) {
      wisdomSection.classList.remove('hidden');
    }
  } catch (err) {
    console.error('Refresh error:', err);
    showError('Impossibile caricare i dati. Sei su AssetHub Westend?');
  }
}

// ESEGUE HOP
async function executeHop() {
  if (!contract) {
    showError('Wallet non connesso.');
    return;
  }
  
  try {
    console.log('Eseguendo Hop...');
    const tx = await contract.hop();
    console.log('Transazione inviata:', tx.hash);
    
    const receipt = await tx.wait();
    console.log('Transazione confermata:', receipt.transactionHash);
    
    await refreshData();
  } catch (err) {
    console.error('Hop error:', err);
    if (err.code === 4001) {
      showError('Transazione annullata.');
    } else if (err.message?.includes('insufficient funds')) {
      showError('Gas insufficiente. Ottieni WND dal faucet.');
    } else if (err.message?.includes('execution reverted')) {
      showError('Transazione fallita. Il contratto ha rifiutato l\'azione.');
    } else {
      showError(`Errore Hop: ${err.message || 'Sconosciuto'}`);
    }
  }
}

// CLAIM WISDOM
async function claimWisdom() {
  if (!contract) {
    showError('Wallet non connesso.');
    return;
  }
  
  try {
    console.log('Richiedendo Wisdom...');
    const tx = await contract.claimWisdom();
    console.log('Transazione inviata:', tx.hash);
    
    const receipt = await tx.wait();
    console.log('Transazione confermata:', receipt.transactionHash);
    
    wisdomSection.classList.remove('hidden');
    await refreshData();
  } catch (err) {
    console.error('Claim error:', err);
    if (err.code === 4001) {
      showError('Transazione annullata.');
    } else if (err.message?.includes('Need 1 HOP')) {
      showError('Necessario almeno 1 token HOP per richiedere la saggezza.');
    } else if (err.message?.includes('execution reverted')) {
      showError('Transazione fallita. Verifica il tuo saldo HOP.');
    } else {
      showError(`Errore Claim: ${err.message || 'Sconosciuto'}`);
    }
  }
}

// MOSTRA ERRORE
function showError(message) {
  errorMessage.textContent = message;
  errorModal.classList.remove('hidden');
}

// AVVIA
document.addEventListener('DOMContentLoaded', init);


              </script>
                        </body>
                        </html>
                    
